{% extends "base.html" %}

{% block title %}Dashboard - Energy Insight{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Energy Dashboard</h1>
    <div>
        <a href="{{ url_for('settings.index') }}" class="btn btn-outline-secondary">
            <i class="bi bi-gear"></i> Settings
        </a>
    </div>
</div>

<div class="card mb-4">
    <div class="card-header">
        <h5 class="card-title mb-0">Dashboard Controls</h5>
    </div>
    <div class="card-body">
        <form id="dashboard-form" method="get" action="{{ url_for('dashboard.index') }}">
            <div class="row">
                <!-- Time Range Selector -->
                <div class="col-md-4 mb-3">
                    <label for="time-range" class="form-label">Time Range</label>
                    <select class="form-select" id="time-range" name="time_range">
                        <option value="ytd" {% if time_range == 'ytd' %}selected{% endif %}>Year to Date</option>
                        <option value="7d" {% if time_range == '7d' %}selected{% endif %}>Last 7 days</option>
                        <option value="30d" {% if time_range == '30d' %}selected{% endif %}>Last 30 days</option>
                        <option value="90d" {% if time_range == '90d' %}selected{% endif %}>Last 90 days</option>
                        <option value="1y" {% if time_range == '1y' %}selected{% endif %}>Last year</option>
                        <option value="2y" {% if time_range == '2y' %}selected{% endif %}>Last 2 years</option>
                        <option value="5y" {% if time_range == '5y' %}selected{% endif %}>Last 5 years</option>
                        <option value="custom" {% if time_range == 'custom' %}selected{% endif %}>Custom date range</option>
                    </select>
                </div>
                
                <!-- Data Aggregation -->
                <div class="col-md-4 mb-3">
                    <label for="aggregation" class="form-label">Data Aggregation</label>
                    <select class="form-select" id="aggregation" name="aggregation">
                        <option value="auto" {% if not aggregation or aggregation == 'auto' %}selected{% endif %}>Auto</option>
                        <option value="day" {% if aggregation == 'day' %}selected{% endif %}>Daily</option>
                        <option value="week" {% if aggregation == 'week' %}selected{% endif %}>Weekly</option>
                        <option value="month" {% if aggregation == 'month' %}selected{% endif %}>Monthly</option>
                        <option value="quarter" {% if aggregation == 'quarter' %}selected{% endif %}>Quarterly</option>
                        <option value="year" {% if aggregation == 'year' %}selected{% endif %}>Yearly</option>
                    </select>
                </div>
                
                <!-- Energy Type -->
                <div class="col-md-4 mb-3">
                    <label for="energy-type" class="form-label">Energy Type</label>
                    <select class="form-select" id="energy-type" name="energy_type">
                        <option value="total" {% if energy_type == 'total' %}selected{% endif %}>Total</option>
                        <option value="heating" {% if energy_type == 'heating' %}selected{% endif %}>Heating</option>
                        <option value="hot_water" {% if energy_type == 'hot_water' %}selected{% endif %}>Hot Water</option>
                    </select>
                </div>
            </div>
            
            <!-- Custom Date Range Inputs (initially hidden) -->
            <div class="row custom-date-range" {% if time_range != 'custom' %}style="display: none;"{% endif %}>
                <div class="col-md-4 mb-3">
                    <label for="start-date" class="form-label">Start Date</label>
                    <input type="date" class="form-control" id="start-date" name="start_date" value="{{ start_date|string }}">
                </div>
                <div class="col-md-4 mb-3">
                    <label for="end-date" class="form-label">End Date</label>
                    <input type="date" class="form-control" id="end-date" name="end_date" value="{{ end_date|string }}">
                </div>
                <div class="col-md-4 d-flex align-items-end mb-3">
                    <button type="submit" class="btn btn-primary">Apply</button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Energy Consumption Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">Energy</h5>
                <div class="btn-group btn-group-sm" role="group">
                    <button type="button" class="btn btn-outline-secondary energy-view active" data-view="consumption">Consumption</button>
                    <button type="button" class="btn btn-outline-secondary energy-view" data-view="production">Production</button>
                    <button type="button" class="btn btn-outline-secondary energy-view" data-view="both">Both</button>
                </div>
            </div>
            <div class="card-body">
                <div class="chart-container" style="position: relative; height:400px;">
                    <canvas id="energy-chart"></canvas>
                </div>
                <!-- Debug info -->
                <div class="mt-2 small text-muted">
                    {% if 'energy_chart' in charts %}
                    <p>Chart data available</p>
                    {% else %}
                    <p>No energy chart data available</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- COP Chart -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Heat Pump Efficiency (COP)</h5>
            </div>
            <div class="card-body">
                <div class="chart-container" style="position: relative; height:400px;">
                    <canvas id="cop-chart"></canvas>
                </div>
                <!-- Debug info -->
                <div class="mt-2 small text-muted">
                    {% if 'cop_chart' in charts %}
                    <p>Chart data available</p>
                    {% else %}
                    <p>No COP chart data available</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Cost Comparison Chart -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Cost Comparison: Heat Pump vs Diesel</h5>
            </div>
            <div class="card-body">
                <div class="chart-container" style="position: relative; height:400px;">
                    <canvas id="cost-chart"></canvas>
                </div>
                <!-- Debug info -->
                <div class="mt-2 small text-muted">
                    {% if 'cost_chart' in charts %}
                    <p>Chart data available</p>
                    {% else %}
                    <p>No cost chart data available</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Temperature Chart -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Temperature Trends</h5>
            </div>
            <div class="card-body">
                <div class="chart-container" style="position: relative; height:400px;">
                    <canvas id="temp-chart"></canvas>
                </div>
                <!-- Debug info -->
                <div class="mt-2 small text-muted">
                    {% if 'temp_chart' in charts %}
                    <p>Chart data available</p>
                    {% else %}
                    <p>No temperature chart data available</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function() {
    // Parse chart data from server
    var chartData = {{ charts|tojson|safe }};
    
    console.log("Chart data received:", chartData);
    
    // Render energy chart
    if (chartData.energy_chart) {
        try {
            var energyChartConfig = JSON.parse(chartData.energy_chart);
            console.log("Energy chart data parsed successfully");
            var energyCtx = document.getElementById('energy-chart').getContext('2d');
            var energyChart = new Chart(energyCtx, energyChartConfig);
            
            // Handle energy view changes (consumption, production, both)
            document.querySelectorAll('.energy-view').forEach(function(button) {
                button.addEventListener('click', function() {
                    // Update active button
                    document.querySelectorAll('.energy-view').forEach(function(b) {
                        b.classList.remove('active');
                    });
                    this.classList.add('active');
                    
                    var view = this.getAttribute('data-view');
                    
                    // Update chart visibility based on view
                    if (view === 'consumption') {
                        energyChart.data.datasets[0].hidden = false;
                        energyChart.data.datasets[1].hidden = true;
                    } else if (view === 'production') {
                        energyChart.data.datasets[0].hidden = true;
                        energyChart.data.datasets[1].hidden = false;
                    } else { // both
                        energyChart.data.datasets[0].hidden = false;
                        energyChart.data.datasets[1].hidden = false;
                    }
                    
                    energyChart.update();
                });
            });
        } catch (e) {
            console.error("Error parsing energy chart data:", e);
            document.getElementById('energy-chart').parentNode.innerHTML = '<div class="alert alert-danger">Error loading energy chart: ' + e.message + '</div>';
        }
    } else {
        console.warn("No energy chart data available");
        document.getElementById('energy-chart').parentNode.innerHTML = '<div class="alert alert-warning">No energy data available</div>';
    }
    
    // Render COP chart
    if (chartData.cop_chart) {
        try {
            var copChartConfig = JSON.parse(chartData.cop_chart);
            console.log("COP chart data parsed successfully");
            var copCtx = document.getElementById('cop-chart').getContext('2d');
            new Chart(copCtx, copChartConfig);
        } catch (e) {
            console.error("Error parsing COP chart data:", e);
            document.getElementById('cop-chart').parentNode.innerHTML = '<div class="alert alert-danger">Error loading COP chart: ' + e.message + '</div>';
        }
    } else {
        console.warn("No COP chart data available");
        document.getElementById('cop-chart').parentNode.innerHTML = '<div class="alert alert-warning">No COP data available</div>';
    }
    
    // Render cost chart
    if (chartData.cost_chart) {
        try {
            var costChartConfig = JSON.parse(chartData.cost_chart);
            console.log("Cost chart data parsed successfully");
            var costCtx = document.getElementById('cost-chart').getContext('2d');
            new Chart(costCtx, costChartConfig);
        } catch (e) {
            console.error("Error parsing cost chart data:", e);
            document.getElementById('cost-chart').parentNode.innerHTML = '<div class="alert alert-danger">Error loading cost chart: ' + e.message + '</div>';
        }
    } else {
        console.warn("No cost chart data available");
        document.getElementById('cost-chart').parentNode.innerHTML = '<div class="alert alert-warning">No cost data available</div>';
    }
    
    // Render temperature chart
    if (chartData.temp_chart) {
        try {
            var tempChartConfig = JSON.parse(chartData.temp_chart);
            console.log("Temperature chart data parsed successfully");
            var tempCtx = document.getElementById('temp-chart').getContext('2d');
            new Chart(tempCtx, tempChartConfig);
        } catch (e) {
            console.error("Error parsing temperature chart data:", e);
            document.getElementById('temp-chart').parentNode.innerHTML = '<div class="alert alert-danger">Error loading temperature chart: ' + e.message + '</div>';
        }
    } else {
        console.warn("No temperature chart data available");
        document.getElementById('temp-chart').parentNode.innerHTML = '<div class="alert alert-warning">No temperature data available</div>';
    }
    
    // Handle time range changes
    document.getElementById('time-range').addEventListener('change', function() {
        var selectedValue = this.value;
        var customDateRange = document.querySelector('.custom-date-range');
        
        if (selectedValue === 'custom') {
            customDateRange.style.display = 'flex';
        } else {
            customDateRange.style.display = 'none';
            document.getElementById('dashboard-form').submit();
        }
    });
    
    // Handle form field changes (auto-submit)
    document.getElementById('energy-type').addEventListener('change', function() {
        document.getElementById('dashboard-form').submit();
    });
    
    document.getElementById('aggregation').addEventListener('change', function() {
        document.getElementById('dashboard-form').submit();
    });
})();
</script>
{% endblock %}
