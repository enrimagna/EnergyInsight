{% extends "base.html" %}

{% block title %}Dashboard - Energy Insight{% endblock %}
{% block header %}Energy Dashboard{% endblock %}

{% block content %}
<div class="tab-nav">
    <a href="{{ url_for('dashboard.index') }}" class="tab-nav-item active">Overview</a>
    <a href="{{ url_for('dashboard.index') }}?view=energy" class="tab-nav-item">Energy Details</a>
    <a href="{{ url_for('dashboard.index') }}?view=cost" class="tab-nav-item">Cost Analysis</a>
    <a href="{{ url_for('dashboard.index') }}?view=temperature" class="tab-nav-item">Temperature</a>
</div>

<div class="card mb-4">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="card-title">Time Range</h5>
            <div>
                <button class="btn-outline-custom time-range" data-days="1">Last 24h</button>
                <button class="btn-outline-custom time-range active" data-days="7">Last Week</button>
                <button class="btn-outline-custom time-range" data-days="30">Last Month</button>
                <button class="btn-outline-custom time-range" data-days="90">Last 3 Months</button>
            </div>
        </div>
    </div>
</div>

<!-- Energy Data Table -->
<div class="card mb-4">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="card-title">Energy Consumption Summary</h5>
            <button class="btn-custom" id="refresh-data">
                <i class="bi bi-arrow-clockwise"></i> Refresh Data
            </button>
        </div>
    </div>
    <div class="card-body p-0">
        <table class="data-table">
            <thead>
                <tr>
                    <th style="width: 5%">#</th>
                    <th style="width: 20%">Date</th>
                    <th style="width: 20%">Energy (kWh)</th>
                    <th style="width: 20%">Cost (€)</th>
                    <th style="width: 20%">Status</th>
                    <th style="width: 15%">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for i in range(7) %}
                <tr>
                    <td>{{ i + 1 }}</td>
                    <td>{{ current_date.strftime('%Y-%m-%d') if i == 0 else (current_date - timedelta(days=i)).strftime('%Y-%m-%d') }}</td>
                    <td>{{ (10.5 - i * 0.5)|round(2) }}</td>
                    <td>{{ ((10.5 - i * 0.5) * 0.19)|round(2) }}€</td>
                    <td>
                        {% if i == 0 %}
                        <span class="status-badge in-progress">In Progress</span>
                        {% elif i < 3 %}
                        <span class="status-badge done">Done</span>
                        {% else %}
                        <span class="status-badge done">Done</span>
                        {% endif %}
                    </td>
                    <td>
                        <button class="btn-outline-custom btn-sm">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button class="btn-outline-custom btn-sm">
                            <i class="bi bi-download"></i>
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Energy Consumption Chart -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="card-title">Energy Consumption</h5>
    </div>
    <div class="card-body">
        <div class="chart-container">
            <canvas id="energy-chart"></canvas>
        </div>
    </div>
</div>

<!-- Cost Comparison Chart -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="card-title">Cost Comparison: Heat Pump vs Diesel</h5>
    </div>
    <div class="card-body">
        <div class="chart-container">
            <canvas id="cost-chart"></canvas>
        </div>
    </div>
</div>

<!-- Temperature Chart -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="card-title">Temperature Trends</h5>
    </div>
    <div class="card-body">
        <div class="chart-container">
            <canvas id="temp-chart"></canvas>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function() {
    // Parse chart data from server
    var chartData = JSON.parse('{{ charts|tojson|safe }}');
    console.log("Chart data received:", chartData);

    // Render energy chart
    if (chartData && chartData.energy_chart) {
        try {
            var energyChartConfig = JSON.parse(chartData.energy_chart);
            console.log("Energy chart data parsed successfully");
            var energyCtx = document.getElementById('energy-chart').getContext('2d');
            new Chart(energyCtx, energyChartConfig);
        } catch (e) {
            console.error("Error parsing energy chart data:", e);
            document.getElementById('energy-chart').parentNode.innerHTML = '<div class="alert alert-danger">Error loading energy chart: ' + e.message + '</div>';
        }
    } else {
        console.warn("No energy chart data available");
        document.getElementById('energy-chart').parentNode.innerHTML = '<div class="alert alert-warning">No energy data available</div>';
    }

    // Render cost chart
    if (chartData && chartData.cost_chart) {
        try {
            var costChartConfig = JSON.parse(chartData.cost_chart);
            console.log("Cost chart data parsed successfully");
            var costCtx = document.getElementById('cost-chart').getContext('2d');
            new Chart(costCtx, costChartConfig);
        } catch (e) {
            console.error("Error parsing cost chart data:", e);
            document.getElementById('cost-chart').parentNode.innerHTML = '<div class="alert alert-danger">Error loading cost chart: ' + e.message + '</div>';
        }
    } else {
        console.warn("No cost chart data available");
        document.getElementById('cost-chart').parentNode.innerHTML = '<div class="alert alert-warning">No cost data available</div>';
    }

    // Render temperature chart
    if (chartData && chartData.temp_chart) {
        try {
            var tempChartConfig = JSON.parse(chartData.temp_chart);
            console.log("Temperature chart data parsed successfully");
            var tempCtx = document.getElementById('temp-chart').getContext('2d');
            new Chart(tempCtx, tempChartConfig);
        } catch (e) {
            console.error("Error parsing temperature chart data:", e);
            document.getElementById('temp-chart').parentNode.innerHTML = '<div class="alert alert-danger">Error loading temperature chart: ' + e.message + '</div>';
        }
    } else {
        console.warn("No temperature chart data available");
        document.getElementById('temp-chart').parentNode.innerHTML = '<div class="alert alert-warning">No temperature data available</div>';
    }

    // Handle time range buttons
    var timeRangeButtons = document.querySelectorAll('.time-range');
    Array.prototype.forEach.call(timeRangeButtons, function(button) {
        button.addEventListener('click', function() {
            // Update active button
            Array.prototype.forEach.call(timeRangeButtons, function(b) {
                b.classList.remove('active');
            });
            this.classList.add('active');

            // Get selected days
            var days = this.getAttribute('data-days');

            // Reload the page to get updated charts
            window.location.href = '{{ url_for("dashboard.index") }}?days=' + days;
        });
    });
    
    // Handle refresh button
    document.getElementById('refresh-data').addEventListener('click', function() {
        this.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Refreshing...';
        this.disabled = true;
        
        // Simulate refresh delay
        setTimeout(function() {
            window.location.reload();
        }, 1000);
    });
})();
</script>
{% endblock %}
